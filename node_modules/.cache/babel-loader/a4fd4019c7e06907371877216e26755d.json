{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\gaooooojy\\\\Desktop\\\\project\\\\src\\\\map\\\\map.js\",\n    _s = $RefreshSig$();\n\nimport React, { useRef, useEffect } from 'react';\nimport * as d3 from 'd3';\nimport './map.css';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nfunction Map() {\n  _s();\n\n  const ref = useRef(null);\n  useEffect(() => {\n    new WorldCovid(ref.current);\n  }, []);\n  return /*#__PURE__*/_jsxDEV(\"section\", {\n    id: \"map\",\n    children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n      children: \"WHO Coronavirus (COVID-19) Dashboard\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 14,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      ref: ref,\n      children: \"            \"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 15,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 13,\n    columnNumber: 9\n  }, this);\n}\n\n_s(Map, \"8uVE59eA/r6b92xF80p7sH8rXLk=\");\n\n_c = Map;\n\nclass WorldCovid {\n  constructor(div) {\n    this.div = div;\n    this.getWH(d3.select(this.div));\n    this.addTip();\n    this.initMap();\n  }\n\n  getWH(node) {\n    this.width = node.node().getBoundingClientRect().width;\n    this.height = node.node().getBoundingClientRect().height;\n  }\n\n  addTip() {\n    d3.select(\"body\").selectAll('.d3-tip').data([0]).join(\"div\").attr(\"class\", \"d3-tip\").style(\"display\", \"none\");\n  } // 处理数据,获取最大日期的数据\n\n\n  async initData() {\n    this.world = await d3.json(\"./world.json\");\n    let covid = await d3.json(\"./data.json\");\n    covid.forEach(d => d.date = d3.timeParse(\"%Y-%W\")(d.year_week));\n    let cases = covid.filter(d => d.indicator === \"cases\");\n    let deaths = covid.filter(d => d.indicator !== \"cases\");\n    let maxDate = d3.groups(cases, d => d.country);\n    maxDate.forEach(d => {\n      d[2] = d3.max(d[1], v => v.date);\n    });\n    this.totalCovid_cases = cases.filter(d => {\n      return maxDate.find(v => v[0] === d.country && v[2] === d.date);\n    }); // 求deaths的最大日期数据\n\n    maxDate = d3.groups(deaths, d => d.country);\n    maxDate.forEach(d => {\n      d[2] = d3.max(d[1], v => v.date);\n    });\n    this.totalCovid_deaths = deaths.filter(d => {\n      return maxDate.find(v => v[0] === d.country && v[2] === d.date);\n    });\n    this.add_covid_to_map();\n  } // 将数据添加到地图里\n\n\n  add_covid_to_map() {\n    //联合covid和map数据\n    this.world.features.forEach(d => {\n      let values = this.totalCovid_cases.find(v => d.id === v.country_code);\n\n      if (values) {\n        var _values$cumulative_co;\n\n        d.cumulative_count = (_values$cumulative_co = values.cumulative_count) !== null && _values$cumulative_co !== void 0 ? _values$cumulative_co : 0;\n      }\n    });\n    this.world.features.forEach(d => {\n      let values = this.totalCovid_deaths.find(v => d.id === v.country_code);\n\n      if (values) {\n        var _values$cumulative_co2;\n\n        d.deaths = (_values$cumulative_co2 = values.cumulative_count) !== null && _values$cumulative_co2 !== void 0 ? _values$cumulative_co2 : 0;\n      }\n    });\n  } // 初始化svg容器\n\n\n  initSvg() {\n    this.svg = d3.select(this.div).append(\"svg\");\n    this.svg.attr(\"width\", this.width).attr(\"height\", this.height);\n  } // 初始化地图生成器\n\n\n  async initMap() {\n    await this.initData();\n    this.initSvg();\n    const projection = d3.geoMercator().fitSize([this.width * 0.7, this.height * 0.7], this.world).scale(200);\n    this.path = d3.geoPath().projection(projection);\n    this.map = this.svg.append(\"g\");\n    this.drawMap();\n  } // 画地图\n\n\n  drawMap() {\n    let mapPath = this.map.selectAll(\"path\").data(this.world.features).join(\"path\").attr(\"d\", d => d.properties.name === \"Bermuda\" ? \"M 0,0\" : this.path(d));\n    const color = d3.scaleSqrt().domain([0, d3.max(this.totalCovid_cases, d => +d.cumulative_count)]).range([\"#95dcf4\", \"#007092\"]);\n    mapPath.attr(\"fill\", d => {\n      var _d$cumulative_count;\n\n      return color((_d$cumulative_count = d.cumulative_count) !== null && _d$cumulative_count !== void 0 ? _d$cumulative_count : 0);\n    }).attr(\"stroke\", \"gray\").attr(\"class\", d => d.properties.name).on(\"mouseenter\", (e, d) => {\n      this.tips_show(e, d);\n    }).on(\"mouseleave\", this.tips_hide);\n  }\n\n  tips_show(e, d) {\n    d3.select(\".d3-tip\").style(\"display\", \"block\").style(\"position\", \"absolute\").style(\"top\", `${e.y > this.height * 0.8 ? this.height * 0.8 : e.y}px`).style(\"left\", `${e.x}px`).html(() => ` <section>\n          <div>\n              <p><strong>${d.properties.name}</strong></p>\n              <p>cases:${d.cumulative_count}</p>\n              <p>deaths:${d.deaths}</p>\n            </div>\n          </section>`);\n  }\n\n  tips_hide() {\n    d3.select(\".d3-tip\").style(\"display\", \"none\");\n  }\n\n}\n\nconst svg = d3.select('body').append('svg').attr(\"width\", \"100%\").attr(\"height\", \"900px\").attr(\"display\", \"flex\"); // 请求地图数据\n\nd3.json('countries.geo.json').then(worldGeo => {\n  // 去掉南极洲\n  let worldGeoFeatures = worldGeo.features.filter(d => d.properties.name !== 'Antarctica'); // 去掉南极洲后的世界json数据\n\n  let worldNoATAGeo = {\n    type: \"FeatureCollection\",\n    features: worldGeoFeatures\n  }; // 地图投影-墨卡托投影\n\n  let projection = d3.geoMercator().fitExtent([[30, 80], [1050, 900]], worldNoATAGeo); // 地理路径生成器\n\n  let path = d3.geoPath(projection); // 绘制世界地图\n\n  let worldBase = svg.append('g').attr('class', 'worldMap').selectAll('path').data(worldGeoFeatures).join('path').attr('d', d => path(d)).attr('fill', '#BBB').attr('stroke', '#ADADAD'); //获取全球疫情数据，并根据数据着色\n\n  d3.json('./data.json').then(covData => {\n    let level = ['0-100000', '100001-1000000', '1000001-3000000', '3000001-5000000', '5000001-10000000', '10000000以上']; // 颜色比例尺\n\n    const red = d3.scaleOrdinal(d3.schemeBlues[6]).domain(level);\n    worldBase.style('fill', d => {\n      let name = d.properties.name;\n      let countryNew = covData.filter(item => item.year_week == \"2021-26\");\n      let countryJson = countryNew.filter(item => item.country == name);\n      let count = countryJson.length > 0 ? countryJson[0].cumulative_count : 0;\n      let levelIndex = count < 100000 ? 0 : count < 1000000 ? 1 : count < 3000000 ? 2 : count < 5000000 ? 3 : count < 10000000 ? 4 : 5;\n      return red(level[levelIndex]);\n    });\n  });\n});\nexport default Map; // export default class Map extends Component {\n//     render() {\n//         return (<h1>\n//             欢迎，这里是map!!!!!!!!!!\n//         </h1>)\n//     }\n// }\n\nvar _c;\n\n$RefreshReg$(_c, \"Map\");","map":{"version":3,"sources":["C:/Users/gaooooojy/Desktop/project/src/map/map.js"],"names":["React","useRef","useEffect","d3","Map","ref","WorldCovid","current","constructor","div","getWH","select","addTip","initMap","node","width","getBoundingClientRect","height","selectAll","data","join","attr","style","initData","world","json","covid","forEach","d","date","timeParse","year_week","cases","filter","indicator","deaths","maxDate","groups","country","max","v","totalCovid_cases","find","totalCovid_deaths","add_covid_to_map","features","values","id","country_code","cumulative_count","initSvg","svg","append","projection","geoMercator","fitSize","scale","path","geoPath","map","drawMap","mapPath","properties","name","color","scaleSqrt","domain","range","on","e","tips_show","tips_hide","y","x","html","then","worldGeo","worldGeoFeatures","worldNoATAGeo","type","fitExtent","worldBase","covData","level","red","scaleOrdinal","schemeBlues","countryNew","item","countryJson","count","length","levelIndex"],"mappings":"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","sourcesContent":["import React, { useRef, useEffect } from 'react'\r\nimport * as d3 from 'd3'\r\nimport './map.css'\r\n\r\nfunction Map() {\r\n\r\n    const ref = useRef(null)\r\n    useEffect(() => {\r\n        new WorldCovid(ref.current)\r\n    }, [])\r\n\r\n    return (\r\n        <section id=\"map\">\r\n            <h1>WHO Coronavirus (COVID-19) Dashboard</h1>\r\n            <div ref={ref}>            </div>\r\n        </section>\r\n    )\r\n}\r\n\r\nclass WorldCovid {\r\n\r\n    constructor(div) {\r\n        this.div = div\r\n        this.getWH(d3.select(this.div))\r\n        this.addTip()\r\n        this.initMap();\r\n    }\r\n    getWH(node) {\r\n        this.width = node.node().getBoundingClientRect().width;\r\n        this.height = node.node().getBoundingClientRect().height;\r\n    }\r\n    addTip() {\r\n        d3.select(\"body\").selectAll('.d3-tip').data([0])\r\n            .join(\"div\")\r\n            .attr(\"class\", \"d3-tip\")\r\n            .style(\"display\", \"none\");\r\n    }\r\n    // 处理数据,获取最大日期的数据\r\n    async initData() {\r\n        this.world = await d3.json(\"./world.json\");\r\n        let covid = await d3.json(\"./data.json\");\r\n\r\n        covid.forEach((d) => (d.date = d3.timeParse(\"%Y-%W\")(d.year_week)));\r\n        let cases = covid.filter((d) => d.indicator === \"cases\");\r\n        let deaths = covid.filter((d) => d.indicator !== \"cases\");\r\n\r\n        let maxDate = d3.groups(cases, (d) => d.country);\r\n        maxDate.forEach((d) => {\r\n            d[2] = d3.max(d[1], (v) => v.date);\r\n        });\r\n        this.totalCovid_cases = cases.filter((d) => {\r\n            return maxDate.find((v) => v[0] === d.country && v[2] === d.date);\r\n        });\r\n\r\n        // 求deaths的最大日期数据\r\n        maxDate = d3.groups(deaths, (d) => d.country);\r\n        maxDate.forEach((d) => {\r\n            d[2] = d3.max(d[1], (v) => v.date);\r\n        });\r\n        this.totalCovid_deaths = deaths.filter((d) => {\r\n            return maxDate.find((v) => v[0] === d.country && v[2] === d.date);\r\n        });\r\n        this.add_covid_to_map();\r\n    }\r\n    // 将数据添加到地图里\r\n    add_covid_to_map() {\r\n        //联合covid和map数据\r\n        this.world.features.forEach((d) => {\r\n            let values = this.totalCovid_cases.find((v) => d.id === v.country_code);\r\n            if (values) {\r\n                d.cumulative_count = values.cumulative_count ?? 0;\r\n            }\r\n        });\r\n\r\n        this.world.features.forEach((d) => {\r\n            let values = this.totalCovid_deaths.find((v) => d.id === v.country_code);\r\n            if (values) {\r\n                d.deaths = values.cumulative_count ?? 0;\r\n            }\r\n        });\r\n    }\r\n\r\n    // 初始化svg容器\r\n    initSvg() {\r\n        this.svg = d3.select(this.div).append(\"svg\");\r\n        this.svg.attr(\"width\", this.width).attr(\"height\", this.height);\r\n    }\r\n    // 初始化地图生成器\r\n    async initMap() {\r\n        await this.initData();\r\n        this.initSvg();\r\n        const projection = d3\r\n            .geoMercator()\r\n            .fitSize([this.width*0.7, this.height*0.7], this.world)\r\n            .scale(200);\r\n        this.path = d3.geoPath().projection(projection);\r\n        this.map = this.svg.append(\"g\");\r\n        this.drawMap();\r\n    }\r\n\r\n    // 画地图\r\n    drawMap() {\r\n        let mapPath = this.map\r\n            .selectAll(\"path\")\r\n            .data(this.world.features)\r\n            .join(\"path\")\r\n            .attr(\"d\", (d) =>\r\n                d.properties.name === \"Bermuda\" ? \"M 0,0\" : this.path(d)\r\n            );\r\n\r\n        const color = d3\r\n            .scaleSqrt()\r\n            .domain([0, d3.max(this.totalCovid_cases, (d) => +d.cumulative_count)])\r\n            .range([\"#95dcf4\", \"#007092\"]);\r\n        mapPath\r\n            .attr(\"fill\", (d) => color(d.cumulative_count ?? 0))\r\n            .attr(\"stroke\", \"gray\")\r\n            .attr(\"class\", (d) => d.properties.name)\r\n            .on(\"mouseenter\", (e, d) => {\r\n                this.tips_show(e, d);\r\n            })\r\n            .on(\"mouseleave\", this.tips_hide);\r\n    }\r\n\r\n    tips_show(e, d) {\r\n        d3.select(\".d3-tip\")\r\n            .style(\"display\", \"block\")\r\n            .style(\"position\", \"absolute\")\r\n            .style(\"top\", `${e.y > this.height * 0.8 ? this.height * 0.8 : e.y}px`)\r\n            .style(\"left\", `${e.x}px`)\r\n            .html(\r\n                () => ` <section>\r\n          <div>\r\n              <p><strong>${d.properties.name}</strong></p>\r\n              <p>cases:${d.cumulative_count}</p>\r\n              <p>deaths:${d.deaths}</p>\r\n            </div>\r\n          </section>`\r\n            );\r\n    }\r\n    tips_hide() {\r\n        d3.select(\".d3-tip\").style(\"display\", \"none\");\r\n    }\r\n}\r\n\r\nconst svg = d3.select('body')\r\n    .append('svg')\r\n    .attr(\"width\", \"100%\")\r\n    .attr(\"height\", \"900px\")\r\n    .attr(\"display\", \"flex\");\r\n\r\n\r\n// 请求地图数据\r\nd3.json('countries.geo.json').then(worldGeo => {\r\n    // 去掉南极洲\r\n    let worldGeoFeatures = worldGeo.features.filter(d => d.properties.name!=='Antarctica')\r\n    // 去掉南极洲后的世界json数据\r\n    let worldNoATAGeo = {\r\n        type: \"FeatureCollection\",\r\n        features: worldGeoFeatures\r\n    }\r\n\r\n    // 地图投影-墨卡托投影\r\n    let projection = d3.geoMercator().fitExtent([\r\n        [30,80],\r\n        [1050, 900]\r\n    ], worldNoATAGeo);\r\n    // 地理路径生成器\r\n    let path = d3.geoPath(projection);\r\n    // 绘制世界地图\r\n    let worldBase = svg.append('g')\r\n        .attr('class', 'worldMap')\r\n        .selectAll('path')\r\n        .data(worldGeoFeatures)\r\n        .join('path')\r\n        .attr('d', d => path(d))\r\n        .attr('fill', '#BBB')\r\n        .attr('stroke', '#ADADAD')\r\n\r\n    //获取全球疫情数据，并根据数据着色\r\n    d3.json('./data.json').then(covData => {\r\n        let level = ['0-100000', '100001-1000000', '1000001-3000000', '3000001-5000000', '5000001-10000000', '10000000以上']\r\n        // 颜色比例尺\r\n        const red = d3.scaleOrdinal(d3.schemeBlues[6]).domain(level)\r\n        worldBase.style('fill', d => {\r\n            let name = d.properties.name;\r\n            let countryNew = covData.filter(item => item.year_week == \"2021-26\")\r\n            let countryJson = countryNew.filter(item => item.country == name)\r\n            let count = (countryJson.length > 0) ? countryJson[0].cumulative_count : 0\r\n            let levelIndex = count < 100000 ? 0 : count < 1000000 ? 1 : count < 3000000 ? 2 : count < 5000000 ? 3 :\r\n                count < 10000000 ? 4 : 5\r\n            return red(level[levelIndex])\r\n        })\r\n    })\r\n})\r\n\r\n\r\nexport default Map\r\n\r\n// export default class Map extends Component {\r\n//     render() {\r\n//         return (<h1>\r\n//             欢迎，这里是map!!!!!!!!!!\r\n//         </h1>)\r\n//     }\r\n// }\r\n\r\n"]},"metadata":{},"sourceType":"module"}